<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"> 
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"> 
    <meta name="csrf-token" content=""> 
    <title>Service level and consistency - 开发帮助文档</title> 
    <meta name="keyword" content="mysqlnd-ms.qos-consistency"> 
    <meta name="description" content="mysqlnd-ms.qos-consistency"> 
    <meta name="author" content="Moments"> 
    <link href="/favicon.ico" rel="shortcut icon"> 
    <link href="/css/blog.css" rel="stylesheet"> 
    <script src="/js/blog.js"></script> 
</head>
<body>
<header class="sticky-top">
    <nav class="navbar navbar-expand navbar-dark bg-secondary justify-content-between text-uppercase">
        <div class="navbar-nav" style="overflow:hidden;">
            <a class="navbar-brand" href="https://help.pythonschool.com">
                <span class="d-md-none">
                    <svg class="text-warning" width="24" height="24" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#emoji-sunglasses"/>
                    </svg>
                </span>
                <span class="d-none d-md-flex">开发帮助文档</span>
            </a>
            <div class="navbar-nav-scroll" style="overflow: hidden;">
                <ul class="navbar-nav text-nowrap pb-4" style="overflow:auto;">
                                            <li class="nav-item">
                            <a class="nav-link" href="/docs/laravel/index.html">laravel</a>
                        </li>
                                            <li class="nav-item">
                            <a class="nav-link active" href="/docs/php/index.html">php</a>
                        </li>
                                    </ul>
            </div>
        </div>
        <div class="d-inline-flex">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/liuhuashi">
                        <svg class="text-light" width="24" height="24" fill="currentColor">
                            <use xlink:href="/css/bootstrap-icons.svg#github"/>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<div class="container-fluid">
    <div id="aside-hidden" class="position-fixed" style="left:0;top: 58px;cursor:pointer;z-index: 10000;">
        <svg class="align-text-bottom text-warning" width="16" height="16" fill="currentColor" stroke="currentColor" stroke-width="1">
            <use xlink:href="/css/bootstrap-icons.svg#arrow-left-square"/>
        </svg>
    </div>
    <div class="row">
        <div class="aside col-md-3 col-lg-2 border-right shadow position-sticky" style="overflow:auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
    <form class="row border-bottom p-3 bg-white sticky-top">
        <input id="search-version" class="form-control" data-version="845" type="search" placeholder="英文逗号分隔,分词搜索">
    </form>
    <ul class="nav navbar-nav nav-pills flex-column pt-2 figure-caption">
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.architecture.html" title="Architecture">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Architecture
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.concept_cache.html" title="Cache integration">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Cache integration
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.concept_xa_trx.html" title="XA/Distributed transactions">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    XA/Distributed transactions
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.errorhandling.html" title="错误处理">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    错误处理
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.failover.html" title="错误处理">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    错误处理
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.filter.html" title="Filter">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Filter
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.gtid.html" title="Global transaction IDs">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Global transaction IDs
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.loadbalancing.html" title="负载均衡">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    负载均衡
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.pooling.html" title="连接状态">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    连接状态
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.qos-consistency.html" title="Service level and consistency">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Service level and consistency
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.rwsplit.html" title="Read-write splitting">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Read-write splitting
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.supportedclusters.html" title="Supported clusters">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Supported clusters
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.transaction.html" title="事务控制">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    事务控制
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.transient_errors.html" title="短错误">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    短错误
                </a>
            </li>
            </ul>
</div>        <div class="aside-middle col-md-9 col-lg-10 row">
    <div class="col-md-9 col-xl-10" style="overflow: auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
        <div class="container main-h4-1">
            <div class="page-content">
                <div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.filter.html">« Filter</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.gtid.html">Global transaction IDs »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="documentation.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.concepts.html">概念</a></li>
    <li>Service level and consistency</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.qos-consistency" class="section">
  <h2 class="title">Service level and consistency</h2>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>Version requirement</strong><br>
   </p><p class="para">
    Service levels have been introduced in mysqlnd_ms version 1.2.0-alpha.
    <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>
    requires PHP 5.4.0 or newer.
   </p>
  </blockquote>
  <p class="para">
   The plugin can be used with different kinds of MySQL database clusters.
   Different clusters can deliver different levels of service to applications.
   The service levels can be grouped by the data consistency levels that
   can be achieved. The plugin knows about:
   </p><ul class="itemizedlist">
    <li class="listitem">
     <span class="simpara">eventual consistency</span>
    </li>
    <li class="listitem">
     <span class="simpara">session consistency</span>
    </li>
    <li class="listitem">
     <span class="simpara">strong consistency</span>
    </li>
   </ul>
  
  <p class="para">
   Depending how a cluster is used it may be possible to achieve higher service
   levels than the default one. For example, a read from an asynchronous
   MySQL replication slave is eventual consistent. Thus, one may say the default
   consistency level of a MySQL replication cluster is eventual consistency.
   However, if the master only is used by a client for reading and writing during a
   session, session consistency (read your writes) is given. PECL mysqlnd 1.2.0
   abstracts the details of choosing an appropriate node for any of the above
   service levels from the user.
  </p>
  <p class="para">
   Service levels can be set through the qualify-of-service filter in the
   <a href="mysqlnd-ms.plugin-ini-json.html" class="link">plugins configuration file</a>
   and at runtime using the function
   <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>.
  </p>
  <p class="para">
   The plugin defines the different service levels as follows.
  </p>
  <p class="para">
   Eventual consistency is the default service provided by an asynchronous
   cluster, such as classical MySQL replication. A read operation executed
   on an arbitrary node may or may not return stale data. The applications
   view of the data is eventual consistent.
  </p>
  <p class="para">
   Session consistency is given if a client can always read its own writes.
   An asynchronous MySQL replication cluster can deliver session consistency if clients
   always use the master after the first write or never query a slave which has
   not yet replicated the clients write operation.
  </p>
  <p class="para">
   The plugins understanding of strong consistency is that all clients always
   see the committed writes of all other clients. This is the default when
   using MySQL Cluster or any other cluster offering
   synchronous data distribution.
  </p>
  <p class="para">
   <em class="emphasis">Service level parameters</em>
  </p>
  <p class="para">
   Eventual consistency and session consistency service level accept parameters.
  </p>
  <p class="para">
   Eventual consistency is the service provided by classical MySQL replication.
   By default, all nodes qualify for read requests. An optional <code class="literal">age</code>
   parameter can be given to filter out nodes which lag more than a certain number of
   seconds behind the master. The plugin is using <code class="literal">SHOW SLAVE STATUS</code>
   to measure the lag. Please, see the MySQL reference manual to learn about accuracy and
   reliability of the <code class="literal">SHOW SLAVE STATUS</code> command.
  </p>
  <p class="para">
   Session consistency (read your writes) accepts an optional <code class="literal">GTID</code>
   parameter to consider reading not only from the master but also from slaves
   which already have replicated a certain write described by its transaction identifier.
   This way, when using asynchronous MySQL replication, read requests may be load balanced
   over slaves while still ensuring session consistency.
  </p>
  <p class="para">
   The latter requires the use of
   <a href="mysqlnd-ms.gtid.html" class="link">client-side global transaction id injection</a>.
  </p>
  <p class="para">
   <em class="emphasis">Advantages of the new approach</em>
  </p>
  <p class="para">
   The new approach supersedes the use of SQL hints and the configuration option
   <code class="literal">master_on_write</code> in some respects. If an application
   running on top of an asynchronous MySQL replication cluster cannot accept stale
   data for certain reads, it is easier to tell the plugin to choose appropriate
   nodes than prefixing all read statements in question with the SQL hint
   to enforce the use of the master. Furthermore, the plugin may be able to
   use selected slaves for reading.
  </p>
  <p class="para">
   The <code class="literal">master_on_write</code> configuration option makes the plugin
   use the master after the first write (session consistency, read your writes).
   In some cases, session consistency may not be needed for the rest of the session
   but only for some, few read operations. Thus, <code class="literal">master_on_write</code>
   may result in more read load on the master than necessary. In those cases it
   is better to request a higher than default service level only for those reads
   that actually need it. Once the reads are done, the application can return to
   default service level. Switching between service levels is only possible
   using <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>.
  </p>
  <p class="para">
   <em class="emphasis">Performance considerations</em>
  </p>
  <p class="para">
   A MySQL replication cluster cannot tell clients which slaves are capable
   of delivering which level of service. Thus, in some cases,
   clients need to query the slaves to check their status.
   PECL mysqlnd_ms transparently runs the necessary SQL in the
   background. However, this is an expensive and slow operation. SQL statements
   are run if eventual consistency is combined with an age (slave lag) limit and
   if session consistency is combined with a global transaction ID.
  </p>
  <p class="para">
   If eventual consistency is combined with an maximum age (slave lag), the plugin
   selects candidates for statement execution and load balancing for each statement
   as follows. If the statement is a write all masters are considered as candidates. Slaves
   are not checked and not considered as candidates. If the statement is a read, the
   plugin transparently executes <code class="literal">SHOW SLAVE STATUS</code> on every slaves
   connection. It will loop over all connections, send the statement and then start
   checking for results. Usually, this is slightly faster than a loop over all connections
   in which for every connection a query is send and the plugin waits for its results.
   A slave is considered a candidate if <code class="literal">SHOW SLAVE STATUS</code> reports
   <code class="literal">Slave_IO_Running=Yes</code>,
   <code class="literal">Slave_SQL_Running=Yes</code> and
   <code class="literal">Seconds_Behind_Master</code> is less or equal than the allowed maximum age.
   In case of an SQL error, the plugin emits a warning but does not set an error on
   the connection. The error is not set to make it possible to use the plugin as a drop-in.
  </p>
  <p class="para">
   If session consistency is combined with a global transaction ID, the plugin executes
   the SQL statement set with the <code class="literal">fetch_last_gtid</code> entry of the
   <code class="literal">global_transaction_id_injection</code> section from the plugins configuration file.
   Further details are identical to those described above.
  </p>
  <p class="para">
   In version 1.2.0 no additional optimizations are done for executing background queries.
   Future versions may contain optimizations, depending on user demand.
  </p>
  <p class="para">
   If no parameters and options are set, no SQL is needed. In that case,
   the plugin consider all nodes of the type shown below.
   </p><ul class="itemizedlist">
    <li class="listitem">
     <span class="simpara">eventual consistency, no further options set: all masters, all slaves</span>
    </li>
    <li class="listitem">
     <span class="simpara">session consistency, no further options set: all masters</span>
    </li>
    <li class="listitem">
     <span class="simpara">strong consistency (no options allowed): all masters</span>
    </li>
   </ul>
  
  <p class="para">
    <em class="emphasis">Throttling</em>
  </p>
  <p class="para">
   The quality of service filter can be combined with
   <a href="mysqlnd-ms.gtid.html" class="link">Global transaction IDs</a> to
   throttle clients. Throttling does reduce the write load on the master
   by slowing down clients. If session consistency is requested and
   global transactions idenentifier are used to check the status of
   a slave, the check can be done in two ways. By default a slave
   is checked and skipped immediately if it does not match
   the criteria for session consistency. Alternatively, the
   plugin can wait for a slave to catch up to the master until
   session consistency is possible. To enable the throttling,
   you have to set
   <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.gtid" class="link">wait_for_gtid_timeout</a>
   configuration option.
  </p>
 </div></div></div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-xl-2" id="toc-list">
        <ul></ul>
    </div>
</div>    </div>
</div>
<span id="back-top">
<svg width="20" height="20" fill="currentColor">
    <use xlink:href="/css/bootstrap-icons.svg#chevron-up"/>
</svg>
</span>
 
<script>
    // 浏览量统计
    $(function () {
        let formdata = new FormData();
        formdata.append('_token', '');
        formdata.append('id', 8271);
        $.ajax({
            url: $(".sticky-top .navbar-brand").attr('href') + "/api/doc/clicks",
            type: 'POST',
            data: formdata,
            processData: false,
            contentType: false
        });
    });
    // aside-hidden
    $(function () {
        $('#aside-hidden').on('click', function () {
            $('.aside').toggle(0, function () {
                if ($(this).is(':visible')) {
                    $('.aside-middle').removeClass('col-md-12 col-lg-12').addClass('col-md-9 col-lg-10');
                } else {
                    $('.aside-middle').removeClass('col-md-9 col-lg-10').addClass('col-md-12 col-lg-12');
                }
            });
        });
    });
</script>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?1522d01c436f59ddc8389f25bfa9d53e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</body>
</html>