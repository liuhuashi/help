<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"> 
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"> 
    <meta name="csrf-token" content=""> 
    <title>Eloquent: 关联 - 开发帮助文档</title> 
    <meta name="keyword" content="eloquent-relationships"> 
    <meta name="description" content="eloquent-relationships"> 
    <meta name="author" content="Moments"> 
    <link href="/favicon.ico" rel="shortcut icon"> 
    <link href="/css/blog.css" rel="stylesheet"> 
    <script src="/js/blog.js"></script> 
</head>
<body>
<header class="sticky-top">
    <nav class="navbar navbar-expand navbar-dark bg-secondary justify-content-between text-uppercase">
        <div class="navbar-nav" style="overflow:hidden;">
            <a class="navbar-brand" href="https://help.pythonschool.com">
                <span class="d-md-none">
                    <svg class="text-warning" width="24" height="24" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#emoji-sunglasses"/>
                    </svg>
                </span>
                <span class="d-none d-md-flex">开发帮助文档</span>
            </a>
            <div class="navbar-nav-scroll" style="overflow: hidden;">
                <ul class="navbar-nav text-nowrap pb-4" style="overflow:auto;">
                                            <li class="nav-item">
                            <a class="nav-link active" href="/docs/laravel/index.html">laravel</a>
                        </li>
                                            <li class="nav-item">
                            <a class="nav-link" href="/docs/php/index.html">php</a>
                        </li>
                                    </ul>
            </div>
        </div>
        <div class="d-inline-flex">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/liuhuashi">
                        <svg class="text-light" width="24" height="24" fill="currentColor">
                            <use xlink:href="/css/bootstrap-icons.svg#github"/>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<div class="container-fluid">
    <div id="aside-hidden" class="position-fixed" style="left:0;top: 58px;cursor:pointer;z-index: 10000;">
        <svg class="align-text-bottom text-warning" width="16" height="16" fill="currentColor" stroke="currentColor" stroke-width="1">
            <use xlink:href="/css/bootstrap-icons.svg#arrow-left-square"/>
        </svg>
    </div>
    <div class="row">
        <div class="aside col-md-3 col-lg-2 border-right shadow position-sticky" style="overflow:auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
    <form class="row border-bottom p-3 bg-white sticky-top">
        <input id="search-version" class="form-control" data-version="7" type="search" placeholder="英文逗号分隔,分词搜索">
    </form>
    <ul class="nav navbar-nav nav-pills flex-column pt-2 figure-caption">
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/artisan.html" title="Artisan 命令行">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Artisan 命令行
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/authentication.html" title="用户认证">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    用户认证
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/authorization.html" title="用户授权">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    用户授权
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/blade.html" title="Blade 模板">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Blade 模板
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/broadcasting.html" title="广播系统">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    广播系统
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/cache.html" title="缓存系统">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    缓存系统
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/collections.html" title="集合">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    集合
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/configuration.html" title="Configuration">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Configuration
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/console-tests.html" title="控制台测试">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    控制台测试
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/container.html" title="服务容器">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    服务容器
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/contracts.html" title="契约">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    契约
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/contributions.html" title="贡献导引">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    贡献导引
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/controllers.html" title="Controllers">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Controllers
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/csrf.html" title="CSRF 保护">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    CSRF 保护
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/database-testing.html" title="数据库测试">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库测试
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/database.html" title="数据库: 入门">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库: 入门
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/deployment.html" title="部署">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    部署
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/documentation.html" title="前言">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    前言
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/dusk.html" title="Laravel Dusk">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Dusk
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent-collections.html" title="Eloquent: 集合">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: 集合
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent-mutators.html" title="Eloquent: 修改器">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: 修改器
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent-relationships.html" title="Eloquent: 关联">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: 关联
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent-resources.html" title="Eloquent: API 资源">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: API 资源
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent-serialization.html" title="Eloquent: 序列化">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: 序列化
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/eloquent.html" title="Eloquent: 入门">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Eloquent: 入门
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/encryption.html" title="加密解密">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    加密解密
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/envoy.html" title="Laravel Envoy">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Envoy
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/errors.html" title="错误处理">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    错误处理
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/events.html" title="事件系统">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    事件系统
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/facades.html" title="Facades">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Facades
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/filesystem.html" title="File Storage">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    File Storage
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/frontend.html" title="JavaScript &amp; CSS 脚手架">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    JavaScript &amp; CSS 脚手架
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/hashing.html" title="哈希加密">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    哈希加密
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/helpers.html" title="辅助函数">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    辅助函数
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/homestead.html" title="Laravel Homestead">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Homestead
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/horizon.html" title="Laravel Horizon">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Horizon
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/http-client.html" title="HTTP 客户端">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    HTTP 客户端
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/http-tests.html" title="HTTP Tests">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    HTTP Tests
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/installation.html" title="安装">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    安装
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/lifecycle.html" title="请求生命周期">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    请求生命周期
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/localization.html" title="本地化">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    本地化
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/logging.html" title="日志">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    日志
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/mail.html" title="邮件发送">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    邮件发送
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/middleware.html" title="中间件">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    中间件
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/migrations.html" title="数据库：迁移">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库：迁移
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/mix.html" title="编辑资源 (Mix)">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    编辑资源 (Mix)
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/mocking.html" title="Mocking">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Mocking
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/notifications.html" title="消息通知">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    消息通知
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/packages.html" title="Package Development">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Package Development
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/pagination.html" title="数据库: 分页">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库: 分页
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/passport.html" title="Laravel Passport">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Passport
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/passwords.html" title="重置密码">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    重置密码
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/providers.html" title="服务提供者">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    服务提供者
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/queries.html" title="数据库：查询构造器">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库：查询构造器
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/queues.html" title="队列">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    队列
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/redis.html" title="Redis">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Redis
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/releases.html" title="发行说明">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    发行说明
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/requests.html" title="HTTP 请求">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    HTTP 请求
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/responses.html" title="HTTP Responses">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    HTTP Responses
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/routing.html" title="路由">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    路由
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/sail.html" title="Laravel Sail">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Sail
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/sanctum.html" title="Laravel Sanctum">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Sanctum
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/scheduling.html" title="任务调度">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    任务调度
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/scout.html" title="Laravel Scout">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Scout
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/seeding.html" title="数据库：填充">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    数据库：填充
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/session.html" title="HTTP 会话机制">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    HTTP 会话机制
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/socialite.html" title="Laravel 社会化登录">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel 社会化登录
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/structure.html" title="目录结构">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    目录结构
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/telescope.html" title="Laravel Telescope">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Telescope
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/testing.html" title="测试：入门指南">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    测试：入门指南
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/upgrade.html" title="升级指南">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    升级指南
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/urls.html" title="生成 URL">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    生成 URL
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/valet.html" title="Laravel Valet">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Laravel Valet
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/validation.html" title="表单验证">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    表单验证
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/verification.html" title="Email 认证">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Email 认证
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/laravel_8_zh/views.html" title="视图">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    视图
                </a>
            </li>
            </ul>
</div>        <div class="aside-middle col-md-9 col-lg-10 row">
    <div class="col-md-9 col-xl-10" style="overflow: auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
        <div class="container main-h4-1">
            <div class="page-content">
                <h1>Eloquent: 关联</h1>
<ul>
<li><a href="#introduction">简介</a></li>
<li><a href="#defining-relationships">定义关联</a>
<ul>
<li><a href="#one-to-one">一对一</a></li>
<li><a href="#one-to-many">一对多</a></li>
<li><a href="#one-to-many-inverse">一对多（反向）</a></li>
<li><a href="#many-to-many">多对多</a></li>
<li><a href="#defining-custom-intermediate-table-models">自定义中间表模型</a></li>
<li><a href="#has-one-through">远程一对一</a></li>
<li><a href="#has-many-through">远程一对多</a></li>
</ul></li>
<li><a href="#polymorphic-relationships">多态关联</a>
<ul>
<li><a href="#one-to-one-polymorphic-relations">一对一</a></li>
<li><a href="#one-to-many-polymorphic-relations">一对多</a></li>
<li><a href="#many-to-many-polymorphic-relations">多对多</a></li>
<li><a href="#custom-polymorphic-types">自定义多态模型</a></li>
</ul></li>
<li><a href="#dynamic-relationships">动态关联</a></li>
<li><a href="#querying-relations">查询关联</a>
<ul>
<li><a href="#relationship-methods-vs-dynamic-properties">关联方法 Vs. 动态属性</a></li>
<li><a href="#querying-relationship-existence">基于存在的关联查询</a></li>
<li><a href="#querying-relationship-absence">基于不存在的关联查询</a></li>
<li><a href="#querying-polymorphic-relationships">基于多态的关联查询</a></li>
<li><a href="#counting-related-models">关联数据计数</a></li>
<li><a href="#counting-related-models-on-polymorphic-relationships">多态关联数据计数</a></li>
</ul></li>
<li><a href="#eager-loading">预加载</a>
<ul>
<li><a href="#constraining-eager-loads">为预加载添加约束</a></li>
<li><a href="#lazy-eager-loading">延迟预加载</a></li>
</ul></li>
<li><a href="#inserting-and-updating-related-models">插入 &amp; 更新关联模型</a>
<ul>
<li><a href="#the-save-method"><code>save</code> 方法</a></li>
<li><a href="#the-create-method"><code>create</code> 方法</a></li>
<li><a href="#updating-belongs-to-relationships">更新 Belongs To 关联</a></li>
<li><a href="#updating-many-to-many-relationships">多对多关联</a></li>
</ul></li>
<li><a href="#touching-parent-timestamps">更新父级时间戳</a></li>
</ul>
<p><a name="introduction"></a></p>
<h2>简介</h2>
<p>数据库表通常相互关联。 例如，一篇博客文章可能有许多评论，或者一个订单对应一个下单用户。Eloquent 让这些关联的管理和使用变得简单，并支持多种类型的关联：</p>
<div class="content-list">
<ul>
<li><a href="#one-to-one">一对一</a></li>
<li><a href="#one-to-many">一对多</a></li>
<li><a href="#many-to-many">多对多</a></li>
<li><a href="#has-one-through">远程一对一</a></li>
<li><a href="#has-many-through">远程一对多</a></li>
<li><a href="#one-to-one-polymorphic-relations">一对一（多态关联）</a></li>
<li><a href="#one-to-many-polymorphic-relations">一对多（多态关联）</a></li>
<li><a href="#many-to-many-polymorphic-relations">多对多（多态关联）</a></li>
</ul>
</div>
<p><a name="defining-relationships"></a></p>
<h2>定义关联</h2>
<p>Eloquent 关联在 Eloquent 模型类中以方法的形式呈现。如同 Eloquent 模型本身，关联也可以作为强大的 <a href="/docs/laravel_8_zh/queries.html">查询语句构造器</a> 使用，提供了强大的链式调用和查询功能。例如，我们可以在 <code>posts</code> 关联的链式调用中附加一个约束条件：</p>
<pre><code>$user-&gt;posts()-&gt;where('active', 1)-&gt;get();</code></pre>
<p>不过在深入使用关联之前，让我们先学习如何定义每种关联类型。</p>
<blockquote>
<p>注意：关系名称不能与属性名称冲突，因为这会导致您的模型不知道要解析哪一个。</p>
</blockquote>
<p><a name="one-to-one"></a></p>
<h3>一对一</h3>
<p>一对一是最基本的关联关系。例如，一个 <code>User</code> 模型可能关联一个 <code>Phone</code> 模型。为了定义这个关联，我们要写一个 <code>phone</code> 方法，在 <code>User</code> 模型中。 在 <code>phone</code> 方法内部调用  <code>hasOne</code> 方法并返回其结果：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * 获取与用户相关的电话记录
     */
    public function phone()
    {
        return $this-&gt;hasOne('App\Models\Phone');
    }
}</code></pre>
<p><code>hasOne</code> 方法的第一个参数是关联模型的类名。一旦定义了模型关联，我们就可以使用 Eloquent 的动态属性获得相关的记录。动态属性允许你访问关联方法就像访问模型中定义的属性一样：</p>
<pre><code>$phone = User::find(1)-&gt;phone;</code></pre>
<p>Eloquent 会基于模型名决定外键名称。在这种情况下，会自动假设 <code>Phone</code> 模型有一个 <code>user_id</code> 外键。如果你想覆盖这个约定，可以传递第二个参数给 <code>hasOne</code> 方法：</p>
<pre><code>return $this-&gt;hasOne('App\Models\Phone', 'foreign_key');</code></pre>
<p>另外，Eloquent 假设外键的值是与父级 <code>id</code>（或自定义 <code>$primaryKey</code>）列的值相匹配的。换句话说，Eloquent 将会通过 <code>Phone</code> 记录的 <code>user_id</code> 列中查找与用户表的 <code>id</code> 列相匹配的值。如果您希望该关联使用 <code>id</code> 以外的自定义键名，就可以给 <code>hasOne</code> 方法传递第三个参数：</p>
<pre><code>return $this-&gt;hasOne('App\Models\Phone', 'foreign_key', 'local_key');</code></pre>
<h4>定义反向关联</h4>
<p>我们已经能从 <code>Phone</code> 模型访问到 <code>User</code> 模型了。现在，让我们再在 <code>Phone</code> 模型上定义一个关联，这个关联能让我们访问到拥有该电话的 <code>User</code> 模型。我们就可以使用与 <code>hasOne</code> 方法对应的 <code>belongsTo</code> 方法来定义反向关联：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Phone extends Model
{
    /**
     * 获取拥有此电话的用户
     */
    public function user()
    {
        return $this-&gt;belongsTo('App\Models\User');
    }
}</code></pre>
<p>在上面的例子中， Eloquent 会尝试匹配 <code>Phone</code> 模型上的 <code>user_id</code> 至 <code>User</code> 模型上的 <code>id</code> 。它是通过检查关系方法的名称并使用 <code>_id</code> 作为后缀名来确定默认外键名称的。但是，如果 <code>Phone</code>  模型的外键不是 <code>user_id</code>，那么可以将自定义键名作为第二个参数传递给 <code>belongsTo</code> 方法：</p>
<pre><code>/**
 * 获得拥有此电话的用户
 */
public function user()
{
    return $this-&gt;belongsTo('App\Models\User', 'foreign_key');
}</code></pre>
<p>如果父级模型没有使用 <code>id</code> 作为主键，或者是希望使用不同的字段来连接子级模型，则可以通过给 <code>belongsTo</code> 方法传递第三个参数的形式指定父级数据表的自定义键：</p>
<pre><code>/**
 * 获得拥有此电话的用户
 */
public function user()
{
    return $this-&gt;belongsTo('App\Models\User', 'foreign_key', 'other_key');
}</code></pre>
<p><a name="one-to-many"></a></p>
<h3>一对多</h3>
<p>一对多关联用于定义单个模型拥有任意数量的其它关联模型。例如，一篇博客文章可能会有无限条评论。正如其它所有的 Eloquent 关联一样，一对多关联的定义也是在 Eloquent 模型中写一个方法：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    /**
     * 获取博客文章的评论
     */
    public function comments()
    {
        return $this-&gt;hasMany('App\Models\Comment');
    }
}</code></pre>
<p>记住一点，Eloquent 将会自动确定 <code>Comment</code> 模型的外键属性。按照约定，Eloquent 将会使用所属模型名称的「Snake Case」形式，再加上 <code>_id</code> 后缀作为外键字段。因此，在上面这个例子中，Eloquent 将假定 <code>Comment</code> 模型对应到 <code>Post</code> 模型上的外键就是 <code>post_id</code>。</p>
<p>一旦关系被定义好以后，就可以通过访问 <code>Post</code> 模型的 <code>comments</code> 属性来获取评论的集合。记住，由于 Eloquent 提供了「动态属性，因此我们可以像访问模型的属性一样访问关联方法：</p>
<pre><code>$comments = App\Models\Post::find(1)-&gt;comments;

foreach ($comments as $comment) {
    //
}</code></pre>
<p>当然，由于所有的关联还可以作为查询语句构造器使用，因此你可以使用链式调用的方式，在 <code>comments</code> 方法上添加额外的约束条件：</p>
<pre><code>$comment = App\Models\Post::find(1)-&gt;comments()-&gt;where('title', 'foo')-&gt;first();</code></pre>
<p>正如 <code>hasOne</code> 方法一样，你也可以通过向 <code>hasMany</code> 方法传递附加参数来覆盖默认的外键和本地键:</p>
<pre><code>return $this-&gt;hasMany('App\Models\Comment', 'foreign_key');

return $this-&gt;hasMany('App\Models\Comment', 'foreign_key', 'local_key');</code></pre>
<p><a name="one-to-many-inverse"></a></p>
<h3>一对多 (反向)</h3>
<p>现在我们已经可以访问文章中的所有评论了，让我们再定义一个关系，以允许评论 (comment) 获取它所属的文章 (post) 。这个关联则是 <code>hasMany</code> 关联的反向关联, 需要在子模型中使用 <code>belongsTo</code> 方法来定义它:</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Comment extends Model
{
    /**
     * 获取该评论的所属文章
     */
    public function post()
    {
        return $this-&gt;belongsTo('App\Models\Post');
    }
}</code></pre>
<p>在这个关系定义好后，我们就可以通过访问 <code>Comment</code> 模型中的「动态属性」<code>post</code> 来获取关联的 <code>Post</code> 模型了:</p>
<pre><code>$comment = App\Models\Comment::find(1);

echo $comment-&gt;post-&gt;title;</code></pre>
<p>在上面的例子中，Eloquent 将会尝试匹配 <code>Comment</code> 模型中的 <code>post_id</code> 和 <code>Post</code> 模型中的 <code>id</code> 。Eloquent 会通过检查关联方法名，并在该关联方法名后方加上 <code>_</code> 再加上主键后缀名来确定默认外键名 (foreign_key) 。当然，如果 <code>Comment</code> 模型的外键名不是 <code>post_id</code>， 你也可以通过向 <code>belongsTo</code> 方法传递第二个参数以作为自定义键名:</p>
<pre><code>/**
 * 获取该评论的所属文章
 */
public function post()
{
    return $this-&gt;belongsTo('App\Models\Post', 'foreign_key');
}</code></pre>
<p>如果你的父级数据表不使用 <code>id</code> 作为它的主键，或者你希望用不同的字段来连接子级模型，你可以通过向 <code>belongsTo</code> 方法传递三个参数的形式来指定父级数据表的自定义键:</p>
<pre><code>/**
 * 获取该评论的所属文章
 */
public function post()
{
    return $this-&gt;belongsTo('App\Models\Post', 'foreign_key', 'other_key');
}</code></pre>
<p><a name="many-to-many"></a></p>
<h3>多对多</h3>
<p>多对多关联比 <code>hasOne</code> 和 <code>hasMany</code> 关联稍微复杂些。举个例子，一个用户可以拥有很多种角色，同时这些角色也被其他用户共享。例如，许多用户可能都有「管理员」这个角色。</p>
<h4>表结构</h4>
<p>要定义这种关联，需要三个数据库表： <code>users</code>，<code>roles</code> 和 <code>role_user</code>。<code>role_user</code> 表的命名是由关联的两个模型按照字母顺序来的，并且包含了 <code>user_id</code> 和 <code>role_id</code> 字段：</p>
<pre><code>users
    id - integer
    name - string

roles
    id - integer
    name - string

role_user
    user_id - integer
    role_id - integer</code></pre>
<h4>模型结构</h4>
<p>多对多关联通过调用 <code>belongsToMany</code> 这个内部方法返回的结果来定义，例如，我们在 <code>User</code> 模型中定义 <code>roles</code> 方法：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * 用户拥有的角色
     */
    public function roles()
    {
        return $this-&gt;belongsToMany('App\Models\Role');
    }
}</code></pre>
<p>一旦关联关系被定义后，你可以通过 <code>roles</code>「动态属性」获取用户角色：</p>
<pre><code>$user = App\Models\User::find(1);

foreach ($user-&gt;roles as $role) {
    //
}</code></pre>
<p>当然，像其它所有关联模型一样，你可以使用 <code>roles</code> 方法，利用链式调用对查询语句添加约束条件：</p>
<pre><code>$roles = App\Models\User::find(1)-&gt;roles()-&gt;orderBy('name')-&gt;get();</code></pre>
<p>正如前面所提到的，为了确定关联连接表的表名，Eloquent 会按照字母顺序连接两个关联模型的名字。当然，你也可以不使用这种约定，传递第二个参数到 belongsToMany 方法即可：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Role', 'role_user');</code></pre>
<p>除了自定义连接表的表名，你还可以通过传递额外的参数到 <code>belongsToMany</code> 方法来定义该表中字段的键名。第三个参数是定义此关联的模型在连接表里的外键名，第四个参数是另一个模型在连接表里的外键名：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Role', 'role_user', 'user_id', 'role_id');</code></pre>
<h4>定义反向关联</h4>
<p>要定义多对多的反向关联， 你只需要在关联模型中调用 <code>belongsToMany</code> 方法。我们在 <code>Role</code> 模型中定义 <code>users</code> 方法：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Role extends Model
{
    /**
     * 拥有此角色的用户
     */
    public function users()
    {
        return $this-&gt;belongsToMany('App\Models\User');
    }
}</code></pre>
<p>如你所见，除了引入模型为 <code>App\Models\User</code> 外，其它与在 <code>User</code> 模型中定义的完全一样。由于我们重用了 <code>belongsToMany</code> 方法，自定义连接表表名和自定义连接表里的键的字段名称在这里同样适用。</p>
<h4>获取中间表字段</h4>
<p>就如你刚才所了解的一样，多对多的关联关系需要一个中间表来提供支持， Eloquent 提供了一些有用的方法来和这张表进行交互。例如，假设我们的 <code>User</code> 对象关联了多个 <code>Role</code> 对象。在获得这些关联对象后，可以使用模型的 <code>pivot</code> 属性访问中间表的属性：</p>
<pre><code>$user = App\Models\User::find(1);

foreach ($user-&gt;roles as $role) {
    echo $role-&gt;pivot-&gt;created_at;
}</code></pre>
<p>需要注意的是，我们获取的每个 <code>Role</code> 模型对象，都会被自动赋予 <code>pivot</code> 属性，它代表中间表的一个模型对象，并且可以像其他的 Eloquent 模型一样使用。</p>
<p>默认情况下，<code>pivot</code> 对象只包含两个关联模型的主键，如果你的中间表里还有其他额外字段，你必须在定义关联时明确指出：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Role')-&gt;withPivot('column1', 'column2');</code></pre>
<p>如果你想让中间表自动维护 <code>created_at</code> 和 <code>updated_at</code> 时间戳，那么在定义关联时附加上 <code>withTimestamps</code> 方法即可：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Role')-&gt;withTimestamps();</code></pre>
<blockquote>
<p>注意：在数据透视表上使用时间戳时，该表必须同时具有 <code>created_at</code> 和 <code>updated_at</code> 时间戳字段。</p>
</blockquote>
<h4>自定义 <code>pivot</code> 属性名称</h4>
<p>如前所述，来自中间表的属性可以使用 <code>pivot</code> 属性访问。但是，你可以自由定制此属性的名称，以便更好的反应其在应用中的用途。</p>
<p>例如，如果你的应用中包含可能订阅的用户，则用户与博客之间可能存在多对多的关系。如果是这种情况，你可能希望将中间表访问器命名为 <code>subscription</code> 取代 <code>pivot</code>。这可以在定义关系时使用 <code>as</code> 方法完成：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Podcast')
                -&gt;as('subscription')
                -&gt;withTimestamps();</code></pre>
<p>一旦定义完成，你可以使用自定义名称访问中间表数据：</p>
<pre><code>$users = User::with('podcasts')-&gt;get();

foreach ($users-&gt;flatMap-&gt;podcasts as $podcast) {
    echo $podcast-&gt;subscription-&gt;created_at;
}</code></pre>
<h4>通过中间表过滤关系</h4>
<p>在定义关系时，你还可以使用 <code>wherePivot</code> 和 <code>wherePivotIn</code> 方法来过滤 <code>belongsToMany</code> 返回的结果：</p>
<pre><code>return $this-&gt;belongsToMany('App\Models\Role')-&gt;wherePivot('approved', 1);

return $this-&gt;belongsToMany('App\Models\Role')-&gt;wherePivotIn('priority', [1, 2]);

return $this-&gt;belongsToMany('App\Models\Role')-&gt;wherePivotNotIn('priority', [1, 2]);</code></pre>
<p><a name="defining-custom-intermediate-table-models"></a></p>
<h3>定义中间表模型</h3>
<p>如果你想定义一个自定义模型来表示关联关系中的中间表，可以在定义关联时调用 <code>using</code> 方法。自定义多对多中间表模型都必须扩展自 <code>Illuminate\Database\Eloquent\Relations\Pivot</code> 类，自定义多对多（多态）中间表模型必须继承 <code>Illuminate\Database\Eloquent\Relations\MorphPivot</code> 类。例如，我们在写 <code>Role</code> 模型的关联时，使用自定义中间表模型 <code>RoleUser</code>：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Role extends Model
{
    /**
     * 拥有此角色的所有用户
     */
    public function users()
    {
        return $this-&gt;belongsToMany('App\Models\User')-&gt;using('App\Models\RoleUser');
    }
}</code></pre>
<p>当定义 <code>RoleUser</code> 模型时，我们要扩展 <code>Pivot</code> 类：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\Pivot;

class RoleUser extends Pivot
{
    //
}</code></pre>
<p>你可以组合使用 <code>using</code> 和 <code>withPivot</code> 从中间表来检索列。例如，通过将列名传递给 <code>withPivot</code> 方法，就可以从 <code>UserRole</code> 中间表中检索出 <code>created_by</code> 和 <code>updated_by</code> 两列数据：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Role extends Model
{
    /**
     * 拥有此角色的用户
     */
    public function users()
    {
        return $this-&gt;belongsToMany('App\Models\User')
                        -&gt;using('App\Models\RoleUser')
                        -&gt;withPivot([
                            'created_by',
                            'updated_by',
                        ]);
    }
}</code></pre>
<blockquote>
<p>注意: <code>Pivot</code> 模型可能不使用 <code>SoftDeletes</code> 特性。 如果您需要软删除数据关联记录，请考虑将您的数据关联模型转换为实际的 <code>Eloquent</code> 模型。</p>
</blockquote>
<h4>带有递增 ID 的自定义中继模型</h4>
<p>如果你用一个自定义的中继模型定义了多对多的关系，而且这个中继模型拥有一个自增的主键，你应当确保这个自定义中继模型类中定义了一个 <code>incrementing</code> 属性其值为 <code>true</code>。</p>
<pre><code>/**
 * 标识 ID 是否自增
 *
 * @var bool
 */
public $incrementing = true;</code></pre>
<p><a name="has-one-through"></a></p>
<h3>远程一对一</h3>
<p>远程一对一关联通过一个中间关联模型实现。</p>
<p>例如，一个车辆维修应用中，每个修理工「Mechanic」负责一辆汽车「Car」, 并且每辆汽车「Car」属于一个车主「Owner」。虽然修理工「Mechanic」和车主「Owner」没有直接联系，但是修理工「Mechanic」可以通过汽车「Car」本身对应车主「Owner」。让我们看一下定义此关系所需的表：</p>
<pre><code>mechanics
    id - integer
    name - string

cars
    id - integer
    model - string
    mechanic_id - integer

owners
    id - integer
    name - string
    car_id - integer</code></pre>
<p>现在，我们已经确定了表的关系结构，让我们在 <code>Mechanic</code> 模型上定义关系：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Mechanic extends Model
{
    /**
     * 获取车主信息
     */
    public function carOwner()
    {
        return $this-&gt;hasOneThrough('App\Models\Owner', 'App\Models\Car');
    }
}</code></pre>
<p>传递给 <code>hasOneThrough</code> 方法的第一个参数是我们希望访问的最终模型的名称，而第二个参数是中间模型的名称。</p>
<p>执行关联关系查询时，将使用典型的 eloquent 外键约定。如果您想自定义关系的键，可以将它们作为 <code>hasOneThrough</code> 方法的第三个和第四个参数传递。第三个参数是中间模型上外键的名称。第四个参数是最终模型上外键的名称。第五个参数是本地键，而第六个参数是中间模型的本地键：</p>
<pre><code>class Mechanic extends Model
{
    /**
     * 获取车主信息
     */
    public function carOwner()
    {
        return $this-&gt;hasOneThrough(
            'App\Models\Owner',
            'App\Models\Car',
            'mechanic_id', // 汽车表外键...
            'car_id', // 车主表外键...
            'id', // 修理工表本地键...
            'id' // 汽车表本地键...
        );
    }
}</code></pre>
<p><a name="has-many-through"></a></p>
<h3>远程一对多关联</h3>
<p>远程「一对多」关联提供了方便、简短的方式通过中间的关联来获得远层的关联。例如，一个 <code>Country</code> 模型可以通过中间的 <code>User</code> 模型获得多个 <code>Post</code> 模型。在这个例子中，你可以轻易地收集给定国家的所有博客文章。让我们来看看定义这种关联所需的数据表：</p>
<pre><code>countries
    id - integer
    name - string

users
    id - integer
    country_id - integer
    name - string

posts
    id - integer
    user_id - integer
    title - string</code></pre>
<p>虽然 <code>posts</code> 表中不包含 <code>country_id</code> 字段，但 <code>hasManyThrough</code> 关联能让我们通过 <code>$country-&gt;posts</code> 访问到一个国家下所有的用户文章。为了完成这个查询，Eloquent 会先检查中间表 <code>users</code> 的 <code>country_id</code> 字段，找到所有匹配的用户 ID 后，使用这些 ID，在 <code>posts</code> 表中完成查找。</p>
<p>现在，我们已经知道了定义这种关联所需的数据表结构，接下来，让我们在 <code>Country</code> 模型中定义它：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Country extends Model
{
    /**
     * 当前国家所有文章
     */
    public function posts()
    {
        return $this-&gt;hasManyThrough('App\Models\Post', 'App\Models\User');
    }
}</code></pre>
<p><code>hasManyThrough</code> 方法的第一个参数是我们最终希望访问的模型名称，而第二个参数是中间模型的名称。</p>
<p>当执行关联查询时，通常会使用 Eloquent 约定的外键名。如果你想要自定义关联的键，可以通过给 <code>hasManyThrough</code> 方法传递第三个和第四个参数实现，第三个参数表示中间模型的外键名，第四个参数表示最终模型的外键名。第五个参数表示本地键名，而第六个参数表示中间模型的本地键名：</p>
<pre><code>class Country extends Model
{
    public function posts()
    {
        return $this-&gt;hasManyThrough(
            'App\Models\Post',
            'App\Models\User',
            'country_id', // 国家表外键...
            'user_id', // 用户表外键...
            'id', // 国家表本地键...
            'id' // 用户表本地键...
        );
    }
}</code></pre>
<p><a name="polymorphic-relationships"></a></p>
<h2>多态关联</h2>
<p>多态关联允许目标模型借助单个关联从属于多个模型。</p>
<p><a name="one-to-one-polymorphic-relations"></a></p>
<h3>一对一 (多态)</h3>
<h4>表结构</h4>
<p>一对一多态关联与简单的一对一关联类似；不过，目标模型能够在一个关联上从属于多个模型。例如，博客 <code>Post</code> 和 <code>User</code> 可能共享一个关联到 <code>Image</code> 模型的关系。使用一对一多态关联允许使用一个唯一图片列表同时用于博客文章和用户账户。让我们先看看表结构：</p>
<pre><code>posts
    id - integer
    name - string

users
    id - integer
    name - string

images
    id - integer
    url - string
    imageable_id - integer
    imageable_type - string</code></pre>
<p>要特别留意 <code>images</code> 表的 <code>imageable_id</code> 和 <code>imageable_type</code> 列。 <code>imageable_id</code> 列包含文章或用户的 ID 值，而 <code>imageable_type</code> 列包含的则是父模型的类名。Eloquent 在访问 <code>imageable</code> 时使用 <code>imageable_type</code> 列来判断父模型的「类型」。</p>
<h4>模型结构</h4>
<p>接下来，再看看建立关联的模型定义：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Image extends Model
{
    /**
     * 获取拥有此图片的模型
     */
    public function imageable()
    {
        return $this-&gt;morphTo();
    }
}

class Post extends Model
{
    /**
     * 获取文章图片
     */
    public function image()
    {
        return $this-&gt;morphOne('App\Models\Image', 'imageable');
    }
}

class User extends Model
{
    /**
     * 获取用户图片
     */
    public function image()
    {
        return $this-&gt;morphOne('App\Models\Image', 'imageable');
    }
}</code></pre>
<h4>获取关联</h4>
<p>一旦定义了表和模型，就可以通过模型访问此关联。比如，要获取文章图片，可以使用 <code>image</code> 动态属性：</p>
<pre><code>$post = App\Models\Post::find(1);

$image = $post-&gt;image;</code></pre>
<p>还可以通过访问执行 <code>morphTo</code> 调用的方法名来从多态模型中获知父模型。在这个例子中，就是 <code>Image</code> 模型的 <code>imageable</code> 方法。所以，我们可以像动态属性那样访问这个方法：</p>
<pre><code>$image = App\Models\Image::find(1);

$imageable = $image-&gt;imageable;</code></pre>
<p><code>Image</code> 模型上的 <code>imageable</code> 关系将返回 <code>Post</code> 实例或 <code>User</code> 实例，具体取决于模型拥有图像的类型。如果需要为 <code>morphTo</code> 关系指定自定义的 <code>type</code> 和 <code>id</code> 列，请始终确保将关系名称（应与方法名称完全匹配）作为第一个参数传递：</p>
<pre><code>/**
 * 获取 image 实例所属的模型
 */
public function imageable()
{
    return $this-&gt;morphTo(__FUNCTION__, 'imageable_type', 'imageable_id');
}</code></pre>
<p><a name="one-to-many-polymorphic-relations"></a></p>
<h3>一对多（多态）</h3>
<h4>表结构</h4>
<p>一对多多态关联与简单的一对多关联类似；不过，目标模型可以在一个关联中从属于多个模型。假设应用中的用户可以同时「评论」文章和视频。使用多态关联，可以用单个 <code>comments</code> 表同时满足这些情况。我们还是先来看看用来构建这种关联的表结构：</p>
<pre><code>posts
    id - integer
    title - string
    body - text

videos
    id - integer
    title - string
    url - string

comments
    id - integer
    body - text
    commentable_id - integer
    commentable_type - string</code></pre>
<h4>模型结构</h4>
<p>接下来，看看构建这种关联的模型定义：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Comment extends Model
{
    /**
     * 获取拥有此评论的模型
     */
    public function commentable()
    {
        return $this-&gt;morphTo();
    }
}

class Post extends Model
{
    /**
     * 获取此文章的所有评论
     */
    public function comments()
    {
        return $this-&gt;morphMany('App\Models\Comment', 'commentable');
    }
}

class Video extends Model
{
    /**
     * 获取此视频的所有评论
     */
    public function comments()
    {
        return $this-&gt;morphMany('App\Models\Comment', 'commentable');
    }
}</code></pre>
<h4>获取关联</h4>
<p>一旦定义了数据库表和模型，就可以通过模型访问关联。例如，可以使用 <code>comments</code> 动态属性访问文章的全部评论：</p>
<pre><code>$post = App\Models\Post::find(1);

foreach ($post-&gt;comments as $comment) {
    //
}</code></pre>
<p>您还可以通过访问执行对 <code>morphTo</code> 的调用的方法名来从多态模型获取其所属模型。在我们的例子中，这就是 <code>Comment</code> 模型上的 <code>commentable</code> 方法。因此，我们将以动态属性的形式访问该方法：</p>
<pre><code>$comment = App\Models\Comment::find(1);

$commentable = $comment-&gt;commentable;</code></pre>
<p><code>Comment</code> 模型的 <code>commentable</code> 关联将返回 <code>Post</code> 或 <code>Video</code> 实例，其结果取决于评论所属的模型。</p>
<p><a name="many-to-many-polymorphic-relations"></a></p>
<h3>多对多（多态）</h3>
<h4>表结构</h4>
<p>多对多多态关联比 <code>morphOne</code> 和 <code>morphMany</code> 关联略微复杂一些。例如，博客 <code>Post</code> 和 <code>Video</code> 模型能够共享关联到 <code>Tag</code> 模型的多态关系。使用多对多多态关联允许使用一个唯一标签在博客文章和视频间共享。以下是多对多多态关联的表结构：</p>
<pre><code>posts
    id - integer
    name - string

videos
    id - integer
    name - string

tags
    id - integer
    name - string

taggables
    tag_id - integer
    taggable_id - integer
    taggable_type - string</code></pre>
<h4>模型结构</h4>
<p>接下来，在模型上定义关联。<code>Post</code> 和 <code>Video</code> 模型都有调用 Eloquent 基类上 <code>morphToMany</code> 方法的 <code>tags</code> 方法：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    /**
     * 获取文章的所有标签
     */
    public function tags()
    {
        return $this-&gt;morphToMany('App\Models\Tag', 'taggable');
    }
}</code></pre>
<h4>定义反向关联关系</h4>
<p>下面，需要在 <code>Tag</code> 模型上为每个关联模型定义一个方法。在这个示例中，我们将会定义 <code>posts</code> 方法和 <code>videos</code> 方法：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Tag extends Model
{
    /**
     * 获取被打上此标签的所有文章
     */
    public function posts()
    {
        return $this-&gt;morphedByMany('App\Models\Post', 'taggable');
    }

    /**
     * 获取被打上此标签的所有视频
     */
    public function videos()
    {
        return $this-&gt;morphedByMany('App\Models\Video', 'taggable');
    }
}</code></pre>
<h4>获取关联</h4>
<p>一旦定义了数据库表和模型，就可以通过模型访问关联。例如，可以使用 <code>tags</code> 动态属性访问文章的所有标签：</p>
<pre><code>$post = App\Models\Post::find(1);

foreach ($post-&gt;tags as $tag) {
    //
}</code></pre>
<p>还可以访问执行 <code>morphedByMany</code> 方法调用的方法名来从多态模型获取其所属模型。在这个示例中，就是 <code>Tag</code> 模型的 <code>posts</code> 或 <code>videos</code> 方法。可以像动态属性一样访问这些方法：</p>
<pre><code>$tag = App\Models\Tag::find(1);

foreach ($tag-&gt;videos as $video) {
    //
}</code></pre>
<p><a name="custom-polymorphic-types"></a></p>
<h3>自定义多态类型</h3>
<p>默认情况下， Laravel 使用完全限定类名存储关联模型类型。在上面的一对多示例中， 因为 <code>Comment</code> 可能从属于一个 <code>Post</code> 或一个 <code>Video</code>，默认的 <code>commentable_type</code> 就将分别是 <code>App\Post</code> 或 <code>App\Video</code>。不过，你可能希望数据库与应用的内部结构解耦。在这种情况下，可以定义一个「morph 映射」来通知 Eloquent 使用自定义名称代替对应的类名：</p>
<pre><code>use Illuminate\Database\Eloquent\Relations\Relation;

Relation::morphMap([
    'posts' =&gt; 'App\Models\Post',
    'videos' =&gt; 'App\Models\Video',
]);</code></pre>
<p>可以在 <code>AppServiceProvider</code> 的 <code>boot</code> 函数中注册 <code>morphMap</code>，或者创建一个单独的服务提供者。</p>
<blockquote>
<p>注意：在现有应用程序中添加「morph 映射」时，数据库中仍包含完全限定类的每个可变形 <code>*_type</code> 列值都需要转换为其「映射」名称。</p>
</blockquote>
<p>您可以在运行时使用 <code>getMorphClass</code> 方法确定给定模型的别名。 相反，您可以使用 <code>Relation::getMorphedModel</code> 方法来确定与别名相关联的类名：</p>
<pre><code>use Illuminate\Database\Eloquent\Relations\Relation;

$alias = $post-&gt;getMorphClass();

$class = Relation::getMorphedModel($alias);</code></pre>
<p><a name="dynamic-relationships"></a></p>
<h3>动态关联</h3>
<p>您可以使用 <code>resolveRelationUsing</code> 方法在运行时定义 Eloquent 模型之间的关系。 虽然通常不建议在常规应用程序开发中使用它，但是在开发Laravel软件包时，这有时可能会很有用：</p>
<pre><code>use App\Models\Order;
use App\Models\Customer;

Order::resolveRelationUsing('customer', function ($orderModel) {
    return $orderModel-&gt;belongsTo(Customer::class, 'customer_id');
});</code></pre>
<blockquote>
<p>注意：定义动态关系时，请始终为 eloquent 的关联方法提供显式的键名。</p>
</blockquote>
<p><a name="querying-relations"></a></p>
<h2>查询关联</h2>
<p>由于 Eloquent 关联的所有类型都通过方法定义，你可以调用这些方法，而无需真实执行关联查询。另外，所有 Eloquent 关联类型用作 <a href="/docs/laravel_8_zh/queries.html">查询构造器</a>，允许你在数据库上执行 SQL 之前，持续通过链式调用添加约束。</p>
<p>例如，假设一个博客系统的 <code>User</code> 模型有许多关联的 <code>Post</code> 模型：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * 获取该用户的所有文章
     */
    public function posts()
    {
        return $this-&gt;hasMany('App\Models\Post');
    }
}</code></pre>
<p>你可以查询 <code>posts</code> 关联，并为其添加额外的约束：</p>
<pre><code>$user = App\Models\User::find(1);

$user-&gt;posts()-&gt;where('active', 1)-&gt;get();</code></pre>
<p>你可以在关联上使用任意 <a href="/docs/laravel_8_zh/queries.html">查询构造器</a> 方法，请查阅查询构造器文档，学习那些对你有用的方法。</p>
<h4>在关联之后链式添加 <code>orWhere</code> 条件</h4>
<p>如上所示，你可以在查询关联时自由添加其他约束。但是，在将 <code>orWhere</code> 子句链接到关联时要小心，因为 <code>orWhere</code> 子句将在逻辑上与关联约束处于同一级别：</p>
<pre><code>$user-&gt;posts()
        -&gt;where('active', 1)
        -&gt;orWhere('votes', '&gt;=', 100)
        -&gt;get();

// select * from posts
// where user_id = ? and active = 1 or votes &gt;= 100</code></pre>
<p>在大多数情况下，你可以使用 <a href="/docs/laravel_8_zh/queries.html#parameter-grouping">约束组</a> 在括号中对条件检查进行逻辑分组：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$user-&gt;posts()
        -&gt;where(function (Builder $query) {
            return $query-&gt;where('active', 1)
                         -&gt;orWhere('votes', '&gt;=', 100);
        })
        -&gt;get();

// select * from posts
// where user_id = ? and (active = 1 or votes &gt;= 100)</code></pre>
<p><a name="relationship-methods-vs-dynamic-properties"></a></p>
<h3>关联方法 Vs 动态属性</h3>
<p>如果想访问 Eloquent 关联的所有记录，而不附带查询条件，可以像属性一样访问关联，以 <code>User</code> 和 <code>Post</code> 模型为例，可以这样访问用户的所有文章</p>
<pre><code>$user = App\Models\User::find(1);

foreach ($user-&gt;posts as $post) {
    //
}</code></pre>
<p>动态属性是 「懒加载」 的, 只有实际访问到才会加载关联数据。因此，通常用 <a href="#eager-loading">预加载</a> 来准备模型需要用到的关联数据。预加载能大量减少因加载模型关联执行的 SQL 语句。</p>
<p><a name="querying-relationship-existence"></a></p>
<h3>查询已存在的关联</h3>
<p>在查询时，可能需要将关联记录是否存在作为条件。例如，查出至少有一条评论的文章。可以通过向 <code>has</code> 和 <code>orHas</code> 方法传递关联名称实现：</p>
<pre><code>// 查出至少有一条评论的文章...
$posts = App\Models\Post::has('comments')-&gt;get();</code></pre>
<p>也可以指定运算符和数量来进一步自定义查询：</p>
<pre><code>// 查出至少有三条评论的文章...
$posts = App\Models\Post::has('comments', '&gt;=', 3)-&gt;get();</code></pre>
<p>也可以用「点」语法构造嵌套的 <code>has</code> 语句。例如，查出至少有一条评论和投票的文章：</p>
<pre><code>// 查出至少有一条带投票评论的文章...
$posts = App\Models\Post::has('comments.votes')-&gt;get();</code></pre>
<p>如果需要更多功能，可以使用 <code>whereHas</code> 和 <code>orWhereHas</code> 方法将「where」条件放到 <code>has</code> 查询上。这些方法允许你向关联加入自定义约束，比如检查评论内容：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

// 获取至少带有一条评论内容包含 foo% 关键词的文章...
$posts = App\Models\Post::whereHas('comments', function (Builder $query) {
    $query-&gt;where('content', 'like', 'foo%');
})-&gt;get();

// 获取至少带有十条评论内容包含 foo% 关键词的文章...
$posts = App\Models\Post::whereHas('comments', function (Builder $query) {
    $query-&gt;where('content', 'like', 'foo%');
}, '&gt;=', 10)-&gt;get();</code></pre>
<p><a name="querying-relationship-absence"></a></p>
<h3>查询不存在的关联</h3>
<p>访问模型的记录时，您可能希望根据不存在的关系来筛选结果。例如，假设您要检索所有 <strong>没有</strong> 评论的博客文章。为此，您可以将关系的名称传递给<code>doesntHave</code> 和 <code>orDoesntHave</code> 方法：</p>
<pre><code>$posts = App\Models\Post::doesntHave('comments')-&gt;get();</code></pre>
<p>如果需要更多功能，可以使用 <code>whereDoesntHave</code> 和 <code>orWhereDoesntHave</code> 方法将「where」 条件加到 <code>doesntHave</code> 查询上。这些方法允许你向关联加入自定义限制，比如检测评论内容：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$posts = App\Models\Post::whereDoesntHave('comments', function (Builder $query) {
    $query-&gt;where('content', 'like', 'foo%');
})-&gt;get();</code></pre>
<p>还可以使用「点」语法执行嵌套关联查询。例如，下面的查询用于获取带有没被禁用的作者发表评论的文章：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$posts = App\Models\Post::whereDoesntHave('comments.author', function (Builder $query) {
    $query-&gt;where('banned', 0);
})-&gt;get();</code></pre>
<p><a name="querying-polymorphic-relationships"></a></p>
<h3>多态关联查询</h3>
<p>要查询 <code>MorphTo</code> 关联的存在，可以使用 <code>whereHasMorph</code> 方法及其相应的方法：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

// 查询与帖子或视频相关并且标题包含 foo 的评论...
$comments = App\Models\Comment::whereHasMorph(
    'commentable',
    ['App\Models\Post', 'App\Models\Video'],
    function (Builder $query) {
        $query-&gt;where('title', 'like', 'foo%');
    }
)-&gt;get();

// 查询与帖子相关的评论，标题不包含 foo％...
$comments = App\Models\Comment::whereDoesntHaveMorph(
    'commentable',
    'App\Models\Post',
    function (Builder $query) {
        $query-&gt;where('title', 'like', 'foo%');
    }
)-&gt;get();</code></pre>
<p>你可以使用 <code>$type</code> 参数根据相关模型添加不同的约束：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$comments = App\Models\Comment::whereHasMorph(
    'commentable',
    ['App\Models\Post', 'App\Models\Video'],
    function (Builder $query, $type) {
        $query-&gt;where('title', 'like', 'foo%');

        if ($type === 'App\Models\Post') {
            $query-&gt;orWhere('content', 'like', 'foo%');
        }
    }
)-&gt;get();</code></pre>
<p>您可以提供 <code>*</code> 作为通配符，让 Laravel 从数据库中查询所有可能的多态类型，而不是传递可能的多态模型数组。Laravel 将执行其他查询以执行此操作：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$comments = App\Models\Comment::whereHasMorph('commentable', '*', function (Builder $query) {
    $query-&gt;where('title', 'like', 'foo%');
})-&gt;get();</code></pre>
<p><a name="counting-related-models"></a></p>
<h3>关联模型计数</h3>
<p>如果想要只计算关联结果的统计数量而不需要真实加载它们，可以使用 <code>withCount</code> 方法，它将放在结果模型的 <code>{relation}_count</code> 列。示例如下：</p>
<pre><code>$posts = App\Models\Post::withCount('comments')-&gt;get();

foreach ($posts as $post) {
    echo $post-&gt;comments_count;
}</code></pre>
<p>可以像给查询添加限制一样为多个关系添加「计数」：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$posts = App\Models\Post::withCount(['votes', 'comments' =&gt; function (Builder $query) {
    $query-&gt;where('content', 'like', 'foo%');
}])-&gt;get();

echo $posts[0]-&gt;votes_count;
echo $posts[0]-&gt;comments_count;</code></pre>
<p>还可以给关联计数结果起别名，这允许你在同一关联上添加多个计数：</p>
<pre><code>use Illuminate\Database\Eloquent\Builder;

$posts = App\Models\Post::withCount([
    'comments',
    'comments as pending_comments_count' =&gt; function (Builder $query) {
        $query-&gt;where('approved', false);
    },
])-&gt;get();

echo $posts[0]-&gt;comments_count;

echo $posts[0]-&gt;pending_comments_count;</code></pre>
<p>如果将 <code>withCount</code> 和 <code>select</code> 查询组装在一起，请确保在 <code>select</code> 方法之后调用 <code>withCount</code> ：</p>
<pre><code>$posts = App\Models\Post::select(['title', 'body'])-&gt;withCount('comments')-&gt;get();

echo $posts[0]-&gt;title;
echo $posts[0]-&gt;body;
echo $posts[0]-&gt;comments_count;</code></pre>
<p>此外，使用 <code>loadCount</code> 方法，您可以在父模型被加载后使用关联计数:</p>
<pre><code>$book = App\Models\Book::first();

$book-&gt;loadCount('genres');</code></pre>
<p>如果您需要在预加载查询上设置额外的查询约束，您可以传递一个希望加载的关联数组。数组值应该是 <code>Closure</code> 实例，它接收查询生成器实例:</p>
<pre><code>$book-&gt;loadCount(['reviews' =&gt; function ($query) {
    $query-&gt;where('rating', 5);
}])</code></pre>
<p><a name="counting-related-models-on-polymorphic-relationships"></a></p>
<h3>多态关联计数</h3>
<p>如果您想加载一个 <code>morphTo</code> 关系，以及该关系可能返回的各种实体上的嵌套关系计数，可以将 <code>with</code> 方法与 <code>morphTo</code> 关系的 <code>morphWithCount</code> 方法结合使用。</p>
<p>在此示例中，假设 <code>Photo</code> 和 <code>Post</code> 模型可以创建 <code>ActivityFeed</code> 模型。 另外，我们假设 <code>Photo</code> 模型与 <code>Tag</code> 模型相关联，而 <code>Photo</code> 模型与<code>Comment</code> 模型相关联。</p>
<p>使用这些模型定义和关系，我们可以检索 <code>ActivityFeed</code> 模型实例，并急于加载所有 <code>parentable</code> 模型及其各自的嵌套关系计数：</p>
<pre><code>use Illuminate\Database\Eloquent\Relations\MorphTo;

$activities = ActivityFeed::query()
    -&gt;with(['parentable' =&gt; function (MorphTo $morphTo) {
        $morphTo-&gt;morphWithCount([
            Photo::class =&gt; ['tags'],
            Post::class =&gt; ['comments'],
        ]);
    }])-&gt;get();</code></pre>
<p>另外，如果已经检索了 <code>ActivityFeed</code> 模型，则可以使用 <code>loadMorphCount</code> 方法将所有嵌套的关系计数加载到多态关系的各个实体上：</p>
<pre><code>$activities = ActivityFeed::with('parentable')
    -&gt;get()
    -&gt;loadMorphCount('parentable', [
        Photo::class =&gt; ['tags'],
        Post::class =&gt; ['comments'],
    ]);</code></pre>
<p><a name="eager-loading"></a></p>
<h2>预加载</h2>
<p>当以属性方式访问 Eloquent 关联时，关联数据「懒加载」。这意味着直到第一次访问属性时关联数据才会被真实加载。不过 Eloquent 能在查询父模型时「预先载入」子关联。预加载可以缓解 N + 1 查询问题。为了说明 N + 1 查询问题，考虑 <code>Book</code> 模型关联到 <code>Author</code> 的情形：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Book extends Model
{
    /**
     * 获取书籍作者
     */
    public function author()
    {
        return $this-&gt;belongsTo('App\Models\Author');
    }
}</code></pre>
<p>现在，我们来获取所有的书籍及其作者：</p>
<pre><code>$books = App\Models\Book::all();

foreach ($books as $book) {
    echo $book-&gt;author-&gt;name;
}</code></pre>
<p>此循环将执行一个查询，用于获取全部书籍，然后为每本书执行获取作者的查询。如果我们有 25 本书，此循环将运行 26 个查询：1 个用于查询书籍，25 个附加查询用于查询每本书的作者。</p>
<p>谢天谢地，我们能够使用预加载将操作压缩到只有 2 个查询。在查询时，可以使用 <code>with</code> 方法指定想要预加载的关联：</p>
<pre><code>$books = App\Models\Book::with('author')-&gt;get();

foreach ($books as $book) {
    echo $book-&gt;author-&gt;name;
}</code></pre>
<p>在这个例子中，仅执行了两个查询：</p>
<pre><code>select * from books

select * from authors where id in (1, 2, 3, 4, 5, ...)</code></pre>
<h4>预加载多个关联</h4>
<p>有时，你可能需要在单一操作中预加载几个不同的关联。要达成此目的，只要向 <code>with</code> 方法传递多个关联名称构成的数组参数：</p>
<pre><code>$books = App\Models\Book::with(['author', 'publisher'])-&gt;get();</code></pre>
<h4>嵌套预加载</h4>
<p>可以使用 「点」 语法预加载嵌套关联。比如在一个 Eloquent 语句中预加载所有书籍作者及其联系方式：</p>
<pre><code>$books = App\Models\Book::with('author.contacts')-&gt;get();</code></pre>
<h4>嵌套预加载 <code>morphTo</code> 关联</h4>
<p>如果你希望加载一个 <code>morphTo</code> 关系，以及该关系可能返回的各种实体的嵌套关系，可以将 <code>with</code> 方法与 <code>morphTo</code> 关系的 <code>morphWith</code> 方法结合使用。 为了帮助说明这种方法，让我们参考以下模型：</p>
<pre><code>&lt;?php

use Illuminate\Database\Eloquent\Model;

class ActivityFeed extends Model
{
    /**
     * 获取活动提要记录的父级
     */
    public function parentable()
    {
        return $this-&gt;morphTo();
    }
}</code></pre>
<p>在这个例子中，我们假设 <code>Event</code>，<code>Photo</code> 和 <code>Post</code> 模型可以创建 <code>ActivityFeed</code> 模型。 另外，我们假设 <code>Event</code> 模型属于 <code>Calendar</code> 模型，<code>Photo</code> 模型与 <code>Tag</code> 模型相关联，<code>Post</code> 模型属于 <code>Author</code> 模型。</p>
<p>使用这些模型定义和关联，我们可以查询 <code>ActivityFeed</code> 模型实例并预加载所有 <code>parentable</code> 模型及其各自的嵌套关系：</p>
<pre><code>use Illuminate\Database\Eloquent\Relations\MorphTo;

$activities = ActivityFeed::query()
    -&gt;with(['parentable' =&gt; function (MorphTo $morphTo) {
        $morphTo-&gt;morphWith([
            Event::class =&gt; ['calendar'],
            Photo::class =&gt; ['tags'],
            Post::class =&gt; ['author'],
        ]);
    }])-&gt;get();</code></pre>
<h4>预加载指定列</h4>
<p>并不是总需要获取关系的每一列。在这种情况下，Eloquent 允许你为关联指定想要获取的列：</p>
<pre><code>$books = App\Models\Book::with('author:id,name')-&gt;get();</code></pre>
<blockquote>
<p>注意：在使用这个特性时，一定要在要获取的列的列表中包含 <code>id</code> 列。</p>
</blockquote>
<h4>默认预加载</h4>
<p>有时可能希望在查询模型时始终加载某些关联。 为此，你可以在模型上定义 <code>$with</code> 属性：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Book extends Model
{
    /**
     * 默认加载的关联
     *
     * @var array
     */
    protected $with = ['author'];

    /**
     * 获取书籍作者
     */
    public function author()
    {
        return $this-&gt;belongsTo('App\Models\Author');
    }
}</code></pre>
<p>如果你想从单个查询的 <code>$with</code> 属性中删除一个预加载，你可以使用 <code>without</code> 方法：</p>
<pre><code>$books = App\Models\Book::without('author')-&gt;get();</code></pre>
<p><a name="constraining-eager-loads"></a></p>
<h3>为预加载添加约束</h3>
<p>有时，你可能希望预加载一个关联，同时为预加载查询添加额外查询条件，就像下面的例子：</p>
<pre><code>$users = App\Models\User::with(['posts' =&gt; function ($query) {
    $query-&gt;where('title', 'like', '%first%');
}])-&gt;get();</code></pre>
<p>在这个例子中， Eloquent 将仅预加载那些 <code>title</code> 列包含 <code>first</code> 关键词的文章。也可以调用其它的 <a href="/docs/laravel_8_zh/queries.html">查询构造器</a> 方法进一步自定义预加载操作：</p>
<pre><code>$users = App\Models\User::with(['posts' =&gt; function ($query) {
    $query-&gt;orderBy('created_at', 'desc');
}])-&gt;get();</code></pre>
<blockquote>
<p>注意：在约束预加载时，不能使用 <code>limit</code> 和 <code>take</code> 查询构造器方法。</p>
</blockquote>
<p><a name="lazy-eager-loading"></a></p>
<h3>延迟预加载</h3>
<p>有可能你还希望在模型加载完成后在进行渴求式加载。举例来说，如果你想要根据某个条件动态决定是否加载关联数据，那么 <code>load</code> 方法对你来说会非常有用：</p>
<pre><code>$books = App\Models\Book::all();

if ($someCondition) {
    $books-&gt;load('author', 'publisher');
}</code></pre>
<p>如果你想要在渴求式加载的查询语句中进行条件约束，你可以通过数组的形式去加载，键为对应的关联关系，值为 <code>Closure</code> 闭包函数，该闭包的参数为一个查询实例：</p>
<pre><code>$author-&gt;load(['books' =&gt; function ($query) {
    $query-&gt;orderBy('published_date', 'asc');
}]);</code></pre>
<p>如果希望加载还没有加载的关联关系时，你可以使用 loadMissing 方法：</p>
<pre><code>public function format(Book $book)
{
    $book-&gt;loadMissing('author');

    return [
        'name' =&gt; $book-&gt;name,
        'author' =&gt; $book-&gt;author-&gt;name,
    ];
}</code></pre>
<h4>嵌套延迟预加载 &amp; <code>morphTo</code></h4>
<p>如果希望快速加载 <code>morphTo</code> 关系，以及该关系可能返回的各种实体上的嵌套关系，可以使用 <code>loadMorph</code> 方法。</p>
<p>这个方法接受 <code>morphTo</code> 关系的名称作为它的第一个参数，第二个参数接收模型数组、关系数组。为了帮助说明这个方法，可以看一下以下模型例子:</p>
<pre><code>&lt;?php

use Illuminate\Database\Eloquent\Model;

class ActivityFeed extends Model
{
    /**
     * 获取 activity feed 记录的父级
     */
    public function parentable()
    {
        return $this-&gt;morphTo();
    }
}</code></pre>
<p>在这个例子中，让我们假设 <code>Event</code> 、<code>Photo</code> 和 <code>Post</code> 模型可以创建 <code>ActivityFeed</code> 模型。此外，让我们假设 <code>Event</code> 模型属于 <code>Calendar</code> 模型，<code>Photo</code> 模型与 <code>Tag</code> 模型相关联，<code>Post</code> 模型属于 <code>Author</code> 模型。</p>
<p>使用这些模型定义和关系，我们可以检索 <code>ActivityFeed</code> 模型实例，并立即加载所有 <code>parentable</code> 模型及其各自的嵌套关系:</p>
<pre><code>$activities = ActivityFeed::with('parentable')
    -&gt;get()
    -&gt;loadMorph('parentable', [
        Event::class =&gt; ['calendar'],
        Photo::class =&gt; ['tags'],
        Post::class =&gt; ['author'],
    ]);</code></pre>
<p><a name="inserting-and-updating-related-models"></a></p>
<h2>插入 &amp; 更新关联模型</h2>
<p><a name="the-save-method"></a></p>
<h3>保存方法</h3>
<p>Eloquent 为新模型添加关联提供了便捷的方法。例如，也许你需要添加一个新的 <code>Comment</code> 到一个 <code>Post</code> 模型中。你不用在 <code>Comment</code> 中手动设置 <code>post_id</code> 属性，就可以直接使用关联模型的 <code>save</code> 方法将 <code>Comment</code> 直接插入：</p>
<pre><code>$comment = new App\Models\Comment(['message' =&gt; 'A new comment.']);

$post = App\Models\Post::find(1);

$post-&gt;comments()-&gt;save($comment);</code></pre>
<p>需要注意的是，我们并没有使用动态属性的方式访问 <code>comments</code> 关联。相反，我们调用 <code>comments</code> 方法来获得关联实例。<code>save</code> 方法将自动添加适当的 <code>post_id</code> 值到 <code>Comment</code> 模型中。</p>
<p>如果你需要保存多个关联模型，你可以使用 <code>saveMany</code> 方法：</p>
<pre><code>$post = App\Models\Post::find(1);

$post-&gt;comments()-&gt;saveMany([
    new App\Models\Comment(['message' =&gt; 'A new comment.']),
    new App\Models\Comment(['message' =&gt; 'Another comment.']),
]);</code></pre>
<p><code>save</code>和<code>saveMany</code>方法不会将新模型加载到父模型上。 如果你想在使用<code>save</code>或<code>saveMany</code>方法之后访问该关联，需要使用<code>refresh</code>方法来重新加载模型及其关联：</p>
<pre><code>$post-&gt;comments()-&gt;save($comment);

$post-&gt;refresh();

// 所有评论，包括新保存的评论...
$post-&gt;comments;</code></pre>
<p><a name="the-push-method"></a></p>
<h4>递归保存模型和关联数据</h4>
<p>如果你想 <code>save</code> 你的模型及其所有关联数据，你可以使用 <code>push</code> 方法：</p>
<pre><code>$post = App\Models\Post::find(1);

$post-&gt;comments[0]-&gt;message = 'Message';
$post-&gt;comments[0]-&gt;author-&gt;name = 'Author Name';

$post-&gt;push();</code></pre>
<p><a name="the-create-method"></a></p>
<h3>新增方法</h3>
<p>除了 <code>save</code> 和 <code>saveMany</code> 方法外，你还可以使用 <code>create</code> 方法。它接受一个属性数组，同时会创建模型并插入到数据库中。 还有， <code>save</code> 方法和 <code>create</code> 方法的不同之处在于， <code>save</code> 方法接受一个完整的 Eloquent 模型实例，而 <code>create</code> 则接受普通的 PHP 数组：</p>
<pre><code>$post = App\Models\Post::find(1);

$comment = $post-&gt;comments()-&gt;create([
    'message' =&gt; 'A new comment.',
]);</code></pre>
<blockquote>
<p>技巧：在使用 <code>create</code> 方法前，请务必确保查看过本文档的 <a href="/docs/laravel_8_zh/eloquent.html#mass-assignment">批量赋值</a> 章节。</p>
</blockquote>
<p>你还可以使用 <code>createMany</code> 方法去创建多个关联模型：</p>
<pre><code>$post = App\Models\Post::find(1);

$post-&gt;comments()-&gt;createMany([
    [
        'message' =&gt; 'A new comment.',
    ],
    [
        'message' =&gt; 'Another new comment.',
    ],
]);</code></pre>
<p>你还可以使用 <code>findOrNew</code>、<code>firstOrNew</code>、<code>firstOrCreate</code> 和 <code>updateOrCreate</code> 方法来 <a href="https://laravel.com/docs/laravel_8_zh/eloquent#other-creation-methods">创建和更新关系模型</a>。</p>
<p><a name="updating-belongs-to-relationships"></a></p>
<h3>更新 <code>belongsTo</code> 关联</h3>
<p>当更新 <code>belongsTo</code> 关联时，可以使用 <code>associate</code> 方法。此方法将会在子模型中设置外键：</p>
<pre><code>$account = App\Models\Account::find(10);

$user-&gt;account()-&gt;associate($account);

$user-&gt;save();</code></pre>
<p>当移除 <code>belongsTo</code> 关联时，可以使用 <code>dissociate</code> 方法。此方法会将关联外键设置为 <code>null</code> ：</p>
<pre><code>$user-&gt;account()-&gt;dissociate();

$user-&gt;save();</code></pre>
<p><a name="default-models"></a></p>
<h4>Default Models</h4>
<p><code>belongsTo</code>，<code>hasOne</code>，<code>hasOneThrough</code> 和 <code>morphOne</code> 关系允许你指定默认模型，当给定关系为 <code>null</code> 时，将会返回默认模型。 这种模式被称作 <a href="https://en.wikipedia.org/wiki/Null_Object_pattern">空对象模式</a> ，可以减少你代码中不必要的检查。在下面的例子中，如果发布的帖子没有找到作者， <code>user</code> 方法会返回一个空的 <code>App\Models\User</code> 模型：</p>
<pre><code>/**
 * 获取帖子的作者
 */
public function user()
{
    return $this-&gt;belongsTo('App\Models\User')-&gt;withDefault();
}</code></pre>
<p>如果需要在默认模型里添加属性， 你可以传递数组或者回调方法到 <code>withDefault</code> 中：</p>
<pre><code>/**
 * 获取帖子的作者
 */
public function user()
{
    return $this-&gt;belongsTo('App\Models\User')-&gt;withDefault([
        'name' =&gt; 'Guest Author',
    ]);
}

/**
 * 获取帖子的作者
 */
public function user()
{
    return $this-&gt;belongsTo('App\Models\User')-&gt;withDefault(function ($user, $post) {
        $user-&gt;name = 'Guest Author';
    });
}</code></pre>
<p><a name="updating-many-to-many-relationships"></a></p>
<h3>多对多关联</h3>
<h4>附加 / 分离</h4>
<p>Eloquent 也提供了一些额外的辅助方法，使相关模型的使用更加方便。例如，我们假设一个用户可以拥有多个角色，并且每个角色都可以被多个用户共享。给某个用户附加一个角色是通过向中间表插入一条记录实现的，可以使用 <code>attach</code> 方法完成该操作：</p>
<pre><code>$user = App\Models\User::find(1);

$user-&gt;roles()-&gt;attach($roleId);</code></pre>
<p>在将关系附加到模型时，还可以传递一组要插入到中间表中的附加数据：</p>
<pre><code>$user-&gt;roles()-&gt;attach($roleId, ['expires' =&gt; $expires]);</code></pre>
<p>当然，有时也需要移除用户的角色。可以使用 <code>detach</code> 移除多对多关联记录。<code>detach</code> 方法将会移除中间表对应的记录；但是这两个模型都将会保留在数据库中：</p>
<pre><code>// 移除用户的一个角色...
$user-&gt;roles()-&gt;detach($roleId);

// 移除用户的所有角色...
$user-&gt;roles()-&gt;detach();</code></pre>
<p>为了方便起见，<code>attach</code> 和 <code>detach</code> 也允许传递一个 ID 数组：</p>
<pre><code>$user = App\Models\User::find(1);

$user-&gt;roles()-&gt;detach([1, 2, 3]);

$user-&gt;roles()-&gt;attach([
    1 =&gt; ['expires' =&gt; $expires],
    2 =&gt; ['expires' =&gt; $expires],
]);</code></pre>
<h4>同步关联</h4>
<p>你也可以使用 <code>sync</code> 方法构建多对多关联。<code>sync</code> 方法接收一个 ID 数组以替换中间表的记录。中间表记录中，所有未在 ID 数组中的记录都将会被移除。所以该操作结束后，只有给出数组的 ID 会被保留在中间表中：</p>
<pre><code>$user-&gt;roles()-&gt;sync([1, 2, 3]);</code></pre>
<p>你也可以通过 ID 传递额外的附加数据到中间表：</p>
<pre><code>$user-&gt;roles()-&gt;sync([1 =&gt; ['expires' =&gt; true], 2, 3]);</code></pre>
<p>如果你不想移除现有的 ID，可以使用 <code>syncWithoutDetaching</code> 方法：</p>
<pre><code>$user-&gt;roles()-&gt;syncWithoutDetaching([1, 2, 3]);</code></pre>
<h4>切换关联</h4>
<p>多对多关联也提供了 <code>toggle</code> 方法用于「切换」给定 ID 数组的附加状态。 如果给定的 ID 已被附加在中间表中，那么它将会被移除，同样，如果给定的 ID 已被移除，它将会被附加：</p>
<pre><code>$user-&gt;roles()-&gt;toggle([1, 2, 3]);</code></pre>
<h4>在中间表上保存额外的数据</h4>
<p>当处理多对多关联时，<code>save</code> 方法接收一个额外的数据数组作为第二个参数：</p>
<pre><code>App\Models\User::find(1)-&gt;roles()-&gt;save($role, ['expires' =&gt; $expires]);</code></pre>
<h4>更新中间表记录</h4>
<p>如果你需要在中间表中更新一条已存在的记录，可以使用 <code>updateExistingPivot</code> 。此方法接收中间表的外键与要更新的数据数组进行更新：</p>
<pre><code>$user = App\Models\User::find(1);

$user-&gt;roles()-&gt;updateExistingPivot($roleId, $attributes);</code></pre>
<p><a name="touching-parent-timestamps"></a></p>
<h2>更新父级时间戳</h2>
<p>当一个模型属 <code>belongsTo</code> 或者 <code>belongsToMany</code> 另一个模型时， 例如 <code>Comment</code> 属于 <code>Post</code> ，有时更新子模型导致更新父模型时间戳非常有用。例如，当 <code>Comment</code> 模型被更新时，你需要自动「触发」父级 Post 模型的 <code>updated_at</code> 时间戳的更新。Eloquent 让它变得简单。只要在子模型加一个包含关联名称的 <code>touches</code> 属性即可：</p>
<pre><code>&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Comment extends Model
{
    /**
     * 需要触发的所有关联关系
     *
     * @var array
     */
    protected $touches = ['post'];

    /**
     * 评论所属的文章
     */
    public function post()
    {
        return $this-&gt;belongsTo('App\Models\Post');
    }
}</code></pre>
<p>现在，当你更新 <code>Comment</code> 时，对应父级 <code>Post</code> 模型的 <code>updated_at</code> 字段同时也会被更新，使其更方便得知何时让一个 <code>Post</code> 模型的缓存失效：</p>
<pre><code>$comment = App\Models\Comment::find(1);

$comment-&gt;text = 'Edit to this comment!';

$comment-&gt;save();</code></pre>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-xl-2" id="toc-list">
        <ul></ul>
    </div>
</div>    </div>
</div>
<span id="back-top">
<svg width="20" height="20" fill="currentColor">
    <use xlink:href="/css/bootstrap-icons.svg#chevron-up"/>
</svg>
</span>
 
<script>
    // 浏览量统计
    $(function () {
        let formdata = new FormData();
        formdata.append('_token', '');
        formdata.append('id', 326);
        $.ajax({
            url: $(".sticky-top .navbar-brand").attr('href') + "/api/doc/clicks",
            type: 'POST',
            data: formdata,
            processData: false,
            contentType: false
        });
    });
    // aside-hidden
    $(function () {
        $('#aside-hidden').on('click', function () {
            $('.aside').toggle(0, function () {
                if ($(this).is(':visible')) {
                    $('.aside-middle').removeClass('col-md-12 col-lg-12').addClass('col-md-9 col-lg-10');
                } else {
                    $('.aside-middle').removeClass('col-md-9 col-lg-10').addClass('col-md-12 col-lg-12');
                }
            });
        });
    });
</script>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?1522d01c436f59ddc8389f25bfa9d53e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</body>
</html>