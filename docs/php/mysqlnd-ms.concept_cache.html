<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"> 
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"> 
    <meta name="csrf-token" content=""> 
    <title>Cache integration - 开发帮助文档</title> 
    <meta name="keyword" content="mysqlnd-ms.concept_cache"> 
    <meta name="description" content="mysqlnd-ms.concept_cache"> 
    <meta name="author" content="Moments"> 
    <link href="/favicon.ico" rel="shortcut icon"> 
    <link href="/css/blog.css" rel="stylesheet"> 
    <script src="/js/blog.js"></script> 
</head>
<body>
<header class="sticky-top">
    <nav class="navbar navbar-expand navbar-dark bg-secondary justify-content-between text-uppercase">
        <div class="navbar-nav" style="overflow:hidden;">
            <a class="navbar-brand" href="https://help.pythonschool.com">
                <span class="d-md-none">
                    <svg class="text-warning" width="24" height="24" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#emoji-sunglasses"/>
                    </svg>
                </span>
                <span class="d-none d-md-flex">开发帮助文档</span>
            </a>
            <div class="navbar-nav-scroll" style="overflow: hidden;">
                <ul class="navbar-nav text-nowrap pb-4" style="overflow:auto;">
                                            <li class="nav-item">
                            <a class="nav-link" href="/docs/laravel/index.html">laravel</a>
                        </li>
                                            <li class="nav-item">
                            <a class="nav-link active" href="/docs/php/index.html">php</a>
                        </li>
                                    </ul>
            </div>
        </div>
        <div class="d-inline-flex">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/liuhuashi">
                        <svg class="text-light" width="24" height="24" fill="currentColor">
                            <use xlink:href="/css/bootstrap-icons.svg#github"/>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<div class="container-fluid">
    <div id="aside-hidden" class="position-fixed" style="left:0;top: 58px;cursor:pointer;z-index: 10000;">
        <svg class="align-text-bottom text-warning" width="16" height="16" fill="currentColor" stroke="currentColor" stroke-width="1">
            <use xlink:href="/css/bootstrap-icons.svg#arrow-left-square"/>
        </svg>
    </div>
    <div class="row">
        <div class="aside col-md-3 col-lg-2 border-right shadow position-sticky" style="overflow:auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
    <form class="row border-bottom p-3 bg-white sticky-top">
        <input id="search-version" class="form-control" data-version="845" type="search" placeholder="英文逗号分隔,分词搜索">
    </form>
    <ul class="nav navbar-nav nav-pills flex-column pt-2 figure-caption">
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.architecture.html" title="Architecture">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Architecture
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.concept_cache.html" title="Cache integration">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Cache integration
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.concept_xa_trx.html" title="XA/Distributed transactions">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    XA/Distributed transactions
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.errorhandling.html" title="错误处理">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    错误处理
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.failover.html" title="错误处理">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    错误处理
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.filter.html" title="Filter">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Filter
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.gtid.html" title="Global transaction IDs">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Global transaction IDs
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.loadbalancing.html" title="负载均衡">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    负载均衡
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.pooling.html" title="连接状态">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    连接状态
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.qos-consistency.html" title="Service level and consistency">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Service level and consistency
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.rwsplit.html" title="Read-write splitting">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Read-write splitting
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.supportedclusters.html" title="Supported clusters">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    Supported clusters
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.transaction.html" title="事务控制">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    事务控制
                </a>
            </li>
                    <li class="nav-item">
                <a class="nav-link" href="/docs/php/mysqlnd-ms.transient_errors.html" title="短错误">
                    <svg class="align-text-bottom text-dark" width="16" height="16" fill="currentColor">
                        <use xlink:href="/css/bootstrap-icons.svg#eyeglasses"/>
                    </svg>
                    短错误
                </a>
            </li>
            </ul>
</div>        <div class="aside-middle col-md-9 col-lg-10 row">
    <div class="col-md-9 col-xl-10" style="overflow: auto;height: calc(100vh - 58px);padding-bottom: calc(100vh/3);">
        <div class="container main-h4-1">
            <div class="page-content">
                <div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.gtid.html">« Global transaction IDs</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.supportedclusters.html">Supported clusters »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="documentation.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.concepts.html">概念</a></li>
    <li>Cache integration</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.concept_cache" class="section">
  <h2 class="title">Cache integration</h2>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>版本需求</strong><br>
   </p><p class="para">
    功能需要 PECL/mysqlnd_ms 1.3.0-beta 以上版本，和 PECL/mysqlnd_qc 1.1.0-alpha
    以上版本。PECL/mysqlnd_ms 必须编译的时候支持这个功能，需要 PHP 5.4.0 以上版本。
   </p>
  </blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>Setup: extension load order</strong><br>
   </p><p class="para">
    PECL/mysqlnd_ms 必须在 PECL/mysqlnd_qc 前面装载。
   </p>
  </blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>功能稳定性</strong><br>
   </p><p class="para">
    继承的缓存提供 beta 品质。
   </p>
  </blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>适用的 MySQL 集群</strong><br>
   </p><p class="para">
    这个功能主要为 MySQL 主从同步提供支持，目前不支持其他的 MySQL 集群方式。如果用它
    替代客户端查询缓存，用户必须手动控制 PECL/mysqlnd_qc。
   </p>
  </blockquote>
  <p class="para">
   Support for MySQL replication clusters (asynchronous primary copy) is the
   main focus of PECL/mysqlnd_ms. The slaves of a MySQL replication cluster
   may or may not reflect the latest updates from the master.
   Slaves are asynchronous and can lag behind the master. A read from a slave
   is eventual consistent from a cluster-wide perspective.
  </p>
  <p class="para">
   The same level of consistency is offered by a local cache using time-to-live (TTL)
   invalidation strategy. Current data or stale data may be served. Eventually, data
   searched for in the cache is not available and the source of the cache needs to
   be accessed.
  </p>
  <p class="para">
   Given that both a MySQL Replication slave (asynchronous secondary) and a local
   TTL-driven cache deliver the same level of service it is possible to transparently
   replace a remote database access with a local cache access to gain better possibility.
  </p>
  <p class="para">
   As of PECL/mysqlnd_ms 1.3.0-beta the plugin is capable of transparently controlling
   PECL/mysqlnd_ms 1.1.0-alpha or newer to cache a read-only query if explicitly
   allowed by setting an appropriate quality of service through
   <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>. Please, see the
   <a href="mysqlnd-ms.quickstart.cache.html" class="link">quickstart</a> for a code example.
   Both plugins must be installed, PECL/mysqlnd_ms must be compiled to support the
   cache feature and PHP 5.4.0 or newer has to be used.
  </p>
  <p class="para">
   Applications have full control of cache usage and can request fresh data
   at any time, if need be. Thec ache usage can be enabled and disabled
   time during the execution of a script. The cache will be used
   if <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> sets the quality of service
   to eventual consistency and enables cache usage. Cache usage is disabled by
   requesting higher consistency levels, for example,
   session consistency (read your writes). Once the quality of service has been
   relaxed to eventual consistency the cache can be used again.
  </p>
  <p class="para">
   If caching is enabled for a read-only statement, PECL/mysqlnd_ms may inject
   <a href="mysqlnd-qc.quickstart.caching.html" class="link">SQL hints to control caching</a>
   by PECL/mysqlnd_qc. It may modify the SQL statement it got from the application.
   Subsequent SQL processors are supposed to ignore the SQL hints. A SQL hint is a
   SQL comment. Comments must not be ignored, for example, by the database server.
  </p>
  <p class="para">
   The TTL of a cache entry is computed on a per statement basis. Applications
   set an maximum age for the data they want to retrieve using
   <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>. The age sets an approximate upper limit
   of how many seconds the data returned may lag behind the master.
  </p>
  <p class="para">
   The following logic is used to compute the actual TTL if caching is enabled.
   The logic takes the estimated slave lag into account for choosing a TTL. If,
   for example, there are two slaves lagging 5 and 10 seconds behind and the maximum
   age allowed is 60 seconds, the TTL is set to 50 seconds. Please note, the
   age setting is no more than an estimated guess.
   </p><ul class="itemizedlist">
    <li class="listitem">
     <span class="simpara">
      Check whether the statement is read-only. If not, don't cache.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      If caching is enabled, check the slave lag of all configured slaves.
      Establish slave connections if none exist so far and lazy connections are
      used.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Send <code class="literal">SHOW SLAVE STATUS</code> to all slaves. Do not wait
      for the first slave to reply before sending to the second slave. Clients
      often wait long for replies, thus we send out all requests in a burst before
      fetching in a second stage.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Loop over all slaves. For every slave wait for its reply. Do not start
      checking another slave before the currently waited for slave has replied.
      Check for <code class="literal">Slave_IO_Running=Yes</code> and <code class="literal">Slave_SQL_Running=Yes</code>.
      If both conditions hold true, fetch the value of <code class="literal">Seconds_Behind_Master</code>.
      In case of any errors or if conditions fail, set an error on the slave connection.
      Skip any such slave connection for the rest of connection filtering.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Search for the maximum value of <code class="literal">Seconds_Behind_Master</code> from
      all slaves that passed the previous conditions. Subtract the value from
      the maximum age provided by the user with <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>.
      Use the result as a TTL.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      The filtering may sort out all slaves. If so, the maximum age is used as
      TTL, because the maximum lag found equals zero. It is perfectly valid to
      sort out all slaves. In the following it is up to subsequent filter
      to decide what to do. The built-in load balancing filter will pick the
      master.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Inject the appropriate SQL hints to enable caching by PECL/mysqlnd_qc.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Proceed with the connection filtering, e.g. apply load balancing rules to
      pick a slave.
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      PECL/mysqlnd_qc is loaded after PECL/mysqlnd_ms by PHP. Thus, it will see
      all query modifications of PECL/mysqlnd_ms and cache the query if instructed
      to do so.
     </span>
    </li>
   </ul>
  
  <p class="para">
   The algorithm may seem expensive. <code class="literal">SHOW SLAVE STATUS</code> is a very
   fast operation. Given a sufficient number of requests and cache hits per second the cost of
   checking the slaves lag can easily outweight the costs of the cache decision.
  </p>
  <p class="para">
   Suggestions on a better algorithm are always welcome.
  </p>
 </div></div></div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-xl-2" id="toc-list">
        <ul></ul>
    </div>
</div>    </div>
</div>
<span id="back-top">
<svg width="20" height="20" fill="currentColor">
    <use xlink:href="/css/bootstrap-icons.svg#chevron-up"/>
</svg>
</span>
 
<script>
    // 浏览量统计
    $(function () {
        let formdata = new FormData();
        formdata.append('_token', '');
        formdata.append('id', 8258);
        $.ajax({
            url: $(".sticky-top .navbar-brand").attr('href') + "/api/doc/clicks",
            type: 'POST',
            data: formdata,
            processData: false,
            contentType: false
        });
    });
    // aside-hidden
    $(function () {
        $('#aside-hidden').on('click', function () {
            $('.aside').toggle(0, function () {
                if ($(this).is(':visible')) {
                    $('.aside-middle').removeClass('col-md-12 col-lg-12').addClass('col-md-9 col-lg-10');
                } else {
                    $('.aside-middle').removeClass('col-md-9 col-lg-10').addClass('col-md-12 col-lg-12');
                }
            });
        });
    });
</script>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?1522d01c436f59ddc8389f25bfa9d53e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</body>
</html>